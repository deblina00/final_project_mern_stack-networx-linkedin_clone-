<%- include('partials/header') %>
<%- include('partials/sidebar') %>

<div class="main-content">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Posts</h3>

    <form class="d-flex" method="GET" action="/posts">
      <input class="form-control me-2" name="q" value="<%= q %>" placeholder="Search posts" />
      <button class="btn btn-primary">Search</button>
    </form>
  </div>

  <div class="card shadow p-3">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th>User</th>
          <th>Description</th>
          <th>Comments</th>
          <th>Likes</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>

      <tbody>
        <% posts.forEach(p => { %>
          <tr id="post-<%= p._id %>">
            <td>
              <strong><%= p.user ? p.user.f_name : 'â€”' %></strong><br>
              <small><%= p.user ? p.user.email : '' %></small>
            </td>

            <td style="max-width:350px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
              <%= p.desc || '' %>
            </td>

            <td><%= p.comments %></td>
            <td><%= p.likes ? p.likes.length : 0 %></td>

            <td class="text-end">
              <% const blocked = !!p.isBlocked; %>

              <div class="d-inline-block me-2 align-middle">
                <div class="form-check form-switch">
                  <input
                    class="form-check-input post-block-switch"
                    type="checkbox"
                    id="post-block-<%= p._id %>"
                    data-id="<%= p._id %>"
                    <%= blocked ? '' : 'checked' %>
                  />
                  <label class="form-check-label" for="post-block-<%= p._id %>"><%= blocked ? 'Blocked' : 'Active' %></label>
                </div>
              </div>

              <button class="btn btn-sm btn-danger" data-delete-url="/posts/<%= p._id %>" data-row-id="post-<%= p._id %>">
                Delete
              </button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <nav class="mt-3">
    <ul class="pagination">
      <% for(let i=1;i<=pages;i++) { %>
        <li class="page-item <%= i===page ? 'active' : '' %>">
          <a class="page-link" href="/posts?page=<%= i %>&q=<%= q %>"><%= i %></a>
        </li>
      <% } %>
    </ul>
  </nav>
</div>

<%- include('partials/footer') %>
<!-- Page scripts -->
<script src="/js/deleteModal.js"></script>
<script src="/js/blockSwitch.js"></script>
<script>
  // initialize: attach delete buttons
  document.querySelectorAll('button[data-delete-url]').forEach(btn => {
    btn.addEventListener('click', () => {
      openConfirmModal({
        title: 'Delete post',
        text: 'Are you sure you want to delete this post? This action cannot be undone.',
        showReason: false,
        onConfirm: async (reason) => {
          const url = btn.dataset.deleteUrl;
          const rowId = btn.dataset.rowId;
          return deleteResource(url, rowId, reason);
        }
      })
    })
  })

  // attach post block switches
  document.querySelectorAll('.post-block-switch').forEach(s => {
    s.addEventListener('change', (ev) => {
      handleBlockSwitch('post', s.dataset.id, s, ev.target.checked)
    })
  })
</script>